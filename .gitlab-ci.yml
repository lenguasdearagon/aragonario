# src https://docs.gitlab.com/ce/ci/examples/test-and-deploy-python-application-to-heroku.html
# src https://gitlab.com/help/ci/quick_start/README

# version used for develop the application (production is going to use python3.5)
image: python:3.6-stretch

# src https://gitlab.com/gitlab-examples/postgres/blob/master/.gitlab-ci.yml
services:
  - postgres:9.6    # debian stable version of postgresql

# This folder is cached between builds
# http://docs.gitlab.com/ce/ci/yaml/README.html#cache
# thanks https://fleschenberg.net/gitlab-pip-cache/
# extra src https://gitlab.com/gitlab-org/gitlab-ce/blob/master/lib/gitlab/ci/templates/Django.gitlab-ci.yml
# extra src https://gitlab.com/gableroux/gitlab-ci-example-django/blob/master/.gitlab-ci.yml
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/pip-cache"

cache:
  paths:
    - "$CI_PROJECT_DIR/pip-cache"
  key: "$CI_PROJECT_ID"

test:
  before_script:
    - python3 -V   # Print out python version for debugging
    - pip3 install . # add linguatec_lexicon to PYTHONPATH
    - pip3 install -r tests/requirements.txt
    - pip3 install psycopg2-binary # postgresql client
  variables:
    DATABASE_URL: "postgres://postgres:postgres@postgres:5432/postgres"
  script:
  - ./runtests.py --settings tests.test_postgres

staging:
  type: deploy
  before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - mkdir -p ~/.ssh
  - eval $(ssh-agent -s)
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  - ssh-add <(echo "$STAGING_PRIVATE_KEY")
  script:
  - apt-get update -qy
  - apt-get install -y --no-install-recommends python3-pip python3-dev
  - ssh -p22 linguatec@api.conectividadcolectiva.org "rm -rf linguatec-lexicon/"
  - ssh -p22 linguatec@api.conectividadcolectiva.org "mkdir -p linguatec-lexicon/sandbox"
  - ssh -p22 linguatec@api.conectividadcolectiva.org "ssh-keyscan -t rsa gitlab.com >> ~/.ssh/known_hosts"
  - ssh -p22 linguatec@api.conectividadcolectiva.org "git clone git@gitlab.com:linguatec/linguatec-lexicon.git linguatec-lexicon/source"
  - ssh -p22 linguatec@api.conectividadcolectiva.org "virtualenv -p /usr/bin/python3 linguatec-lexicon/env"
  - ssh -p22 linguatec@api.conectividadcolectiva.org "linguatec-lexicon/env/bin/pip install -r linguatec-lexicon/source/requirements.txt"
  - ssh -p22 linguatec@api.conectividadcolectiva.org "linguatec-lexicon/env/bin/pip install -e linguatec-lexicon/source/"
  # Requires to have a properly configured django project at ~/sandbox
  - ssh -p22 linguatec@api.conectividadcolectiva.org "linguatec-lexicon/env/bin/python ~/sandbox/manage.py migrate --noinput"
  - ssh -p22 linguatec@api.conectividadcolectiva.org "linguatec-lexicon/env/bin/python ~/sandbox/manage.py collectstatic --noinput"
  # TODO reload apache2
  only:
  - master
